# Expected flow for HITL operator customer query
# Tests that agent fetches Airflow docs before querying warehouse

name: hitl-operator-query
description: |
  When user asks about Human-in-the-loop operators, the agent should:
  1. Recognize this is a product-specific query
  2. Fetch Airflow docs to discover ALL HITL-related operators
  3. Find ApprovalOperator (part of HITL but doesn't contain "HITL" in name)
  4. Query warehouse with complete operator list

queries:
  - "Find customers using Human-in-the-loop operators"
  - "Who uses HITL operators?"
  - "We just released HITLOperator in Airflow. Query customers using those operators."

# Expected sequence of agent actions
expected_flow:
  # Step 1: Agent reads skill instructions
  - action: read
    file_pattern: "analyzing-data/SKILL.md"
    required: true

  # Step 2: Agent recognizes product-specific query and reads discovery guide
  - action: read
    file_pattern: "analyzing-data/reference/discovery.md"
    required: true

  # Step 3: Agent determines docs-first approach
  - action: read
    file_pattern: "analyzing-data/reference/discovery-docs.md"
    required: true

  # Step 4: Agent gets URL patterns
  - action: read
    file_pattern: "analyzing-data/reference/data-tools-context.md"
    required: true

  # Step 5: Agent fetches Airflow HITL docs to discover all operators
  - action: webfetch
    url_pattern: "airflow.apache.org.*hitl"
    required: true
    note: "Must fetch docs to discover ApprovalOperator is part of HITL family"

  # Step 6: (Optional) Agent may check warehouse.md for table info
  - action: read
    file_pattern: "warehouse.md"
    required: false

  # Step 7: Agent queries warehouse with ALL discovered operators
  - action: run_sql
    query_pattern: "(OPERATOR.*IN|WHERE.*OPERATOR).*HITLOperator.*ApprovalOperator"
    required: true
    note: "Query must include ApprovalOperator (discovered from docs)"

# Success criteria
success_criteria:
  - name: fetched_docs
    description: "Agent fetched Airflow HITL documentation"
    check: "webfetch action with airflow.apache.org URL"

  - name: found_approval_operator
    description: "Agent discovered ApprovalOperator from docs"
    check: "run_sql query includes ApprovalOperator"

  - name: complete_operator_list
    description: "Final query includes all HITL operators"
    check: "Query includes HITLOperator, HITLBranchOperator, HITLEntryOperator, ApprovalOperator"

# Known failure modes
failure_modes:
  - name: skipped_docs
    description: "Agent went straight to warehouse without fetching docs"
    symptom: "No webfetch action before run_sql"

  - name: pattern_only
    description: "Agent used ILIKE '%hitl%' without discovering ApprovalOperator"
    symptom: "Query doesn't include ApprovalOperator"

  - name: skipped_discovery_guide
    description: "Agent didn't read discovery.md to determine approach"
    symptom: "No read of discovery.md"
